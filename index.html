<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flipclock@0.7.6/dist/flipclock.min.css">
    <title>Footstep Simulator v22</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 120px);
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .square {
            width: 120px;
            height: 120px;
            background-color: lightgray;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        .rect {
            width: 120px;
            height: 50px;
            background-color: lightgray;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }        
        .active {
            background-color: DeepSkyBlue;
        }
        .lead {
            background-color: red;
        } 
        .warning {
            background-color: yellow;
        }
        .info {
            background-color: lightgreen;
        }          
    </style>
</head>
<body>
    <h1>Footstep Simulator</h1>
    <form id="control-form">
        <label>
            Length (minutes):
            <input type="number" id="length" step="0.1" min="0.1" value="12" required>
        </label>
        <br><br>
        <label>
            BPM:
            <input type="number" id="bpm" min="1" value="100" required>
        </label>
        <br><br>
        <label>
            Switch Interval (minutes):
            <input type="number" id="switch-interval" step="0.1" min="0.1" value="2" required>
        </label>
        <br><br>
        <button type="button" onclick="startSimulation()">Start</button>
    </form>

    <h3 id="countdown" class="info"></h3>
    <h1 id="warning" class="warning">ABOUT TO SWITCH LEG!!!!!!</h1>
    <div class="grid">
        <div id="lead1" class="rect lead">lead</div>
        <div id="lead2" class="rect">lead</div>        
        <div id="square1" class="square">1</div>
        <div id="square2" class="square">2</div>
        <div id="square3" class="square">3</div>
        <div id="square4" class="square">4</div>
    </div>
    <div id="clock"></div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flipclock@0.7.6/dist/flipclock.min.js"></script>
    <script>
        let intervalId;
        document.getElementById('warning').style.visibility = 'hidden'; // Initially hide the div

        async function startSimulation() {
            clearInterval(intervalId);
            const countdown = document.getElementById('countdown');
              for (let i = 5; i >= 1; i--) {
                countdown.textContent = i;
            
                // Wait for 1 second (non-blocking)
                await new Promise(resolve => setTimeout(resolve, 1000));
              }
            countdown.textContent = 0;
            
            const length = parseFloat(document.getElementById('length').value) * 60; // Convert minutes to seconds
            const bpm = parseFloat(document.getElementById('bpm').value);
            const switchInterval = parseFloat(document.getElementById('switch-interval').value) * 60; // Convert minutes to seconds

            const stepDuration = (60 / bpm) * 4; // Time for a full cycle (4 steps)
            const totalSteps = Math.floor(length / stepDuration * 4); // Total steps in the duration
            let switchSteps = Math.floor(switchInterval / stepDuration * 4); // Steps before switching leading leg
            switchSteps += (4 - (switchSteps % 4)) % 4;
            console.log("switchSteps: " + switchSteps)

            const leads = [
                document.getElementById('lead1'),
                document.getElementById('lead2')
              ];
            
            const squares = [
                document.getElementById('square1'),
                document.getElementById('square2'),
                document.getElementById('square3'),
                document.getElementById('square4')
            ];
            const switchedSquares = [
                document.getElementById('square2'),
                document.getElementById('square1'),
                document.getElementById('square4'),
                document.getElementById('square3')
            ];
            
            let currentStep = 0;
            let leadingLeg = 1; // 1 for left, 2 for right

            var clock = $('#clock').FlipClock(length, {
              clockFace: 'HourlyCounter',
              countdown: true
            });            

            function updateSquares() {
                squares.forEach((square, index) => {
                    square.classList.remove('active');
                });
                
                if (currentStep % switchSteps === switchSteps-4) {
                    //warning about to switch leg
                    const warning = document.getElementById('warning');
                    warning.style.visibility = 'visible'; // Make the div visible
                    setTimeout(() => {
                        warning.style.visibility = 'hidden'; // Hide the div after 2 second
                    }, 2000); // 2000 ms = 2 second
                    console.log('warn')
                }
                if (currentStep % switchSteps === 0 && currentStep !== 0) {
                    leadingLeg = leadingLeg === 1 ? 2 : 1;
                    leads.forEach((lead, index) => {
                        lead.classList.remove('lead');
                    });
                    leads[leadingLeg-1].classList.add('lead')
                    console.log('switch')
                }

                const activeSquare = currentStep % 4;
                if (leadingLeg === 1){
                    squares[activeSquare].classList.add('active');
                    console.log(activeSquare)
                }
                else{
                    switchedSquares[activeSquare].classList.add('active');
                    console.log('r'+activeSquare)
                }

                currentStep++;
                if (currentStep >= totalSteps) {
                    clearInterval(intervalId);
                }
            }

            intervalId = setInterval(updateSquares, stepDuration * 1000 / 4);
            updateSquares(); // Run once immediately
        }
    </script>
</body>
</html>
